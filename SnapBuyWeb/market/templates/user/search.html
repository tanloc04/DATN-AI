{% extends 'base_user.html' %}
{% block title %}Tìm kiếm sản phẩm{% endblock %}

{% block content %}
<style>
  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .product-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    background-color: #fff;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .product-img-container {
    height: 160px;
    overflow: hidden;
    text-align: center;
    background: #f8f9fa;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    padding: 8px;
  }

  .product-img-container img {
    max-height: 100%;
    object-fit: contain;
  }

  .product-body {
    padding: 12px;
    text-align: center;
  }

  .product-price {
    color: #198754;
    font-weight: bold;
  }

  mark {
    background-color: #fff3cd;
    padding: 0 2px;
    border-radius: 4px;
  }

</style>

{% macro highlight(text, keyword) %}
  {% if keyword %}
    {{ text|replace(keyword, "<mark>" ~ keyword ~ "</mark>")|safe }}
  {% else %}
    {{ text }}
  {% endif %}
{% endmacro %}

<div class="container mt-4">
  <h2 class="section-title text-center">Kết quả tìm kiếm</h2>

  <!-- Bộ lọc tìm kiếm -->
  <form class="row mb-4" method="get" action="{{ url_for('search_product') }}">
    <div class="col-md-6 mb-2">
      <input type="text" name="q" class="form-control" placeholder="Từ khóa..." value="{{ keyword }}">
    </div>
    <div class="col-md-4 mb-2">
      <select name="sort" class="form-select">
        <option value="">Sắp xếp theo</option>
        <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Giá tăng dần</option>
        <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Giá giảm dần</option>
      </select>
    </div>
    <div class="col-md-2 mb-2">
      <button class="btn btn-primary w-100">Tìm kiếm</button>
    </div>
  </form>

  {% if items %}
  <p class="text-muted mb-3">
      Đã tìm thấy <strong>{{ pagination.total }}</strong> sản phẩm phù hợp với từ khóa
      {% if keyword %}<mark>{{ keyword }}</mark>{% endif %}.
  </p>
  <div class="row row-cols-1 row-cols-md-4 g-4">
    {% for item in items %}
    <div class="col">
      <div class="card product-card h-100">
        <div class="product-img-container">
          <img src="{{ item.image_url }}" alt="{{ item.name }}">
        </div>
        <div class="product-body">
          <h6 class="mb-1">{{ highlight(item.name, keyword) }}</h6>
          <p class="text-muted small text-truncate">{{ highlight(item.description, keyword) }}</p>
          <p class="product-price">{{ "{:,.0f}".format(item.price) }} đ</p>
          <a href="{{ url_for('product_detail', item_id=item.id) }}" class="btn btn-sm btn-primary">Xem</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Phân trang -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('search_product', q=keyword, sort=sort, page=pagination.prev_num) }}">«</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">«</span></li>
      {% endif %}

      {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
        {% if p %}
          <li class="page-item {% if p == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('search_product', q=keyword, sort=sort, page=p) }}">{{ p }}</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('search_product', q=keyword, sort=sort, page=pagination.next_num) }}">»</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">»</span></li>
      {% endif %}
    </ul>
  </nav>

  {% else %}
    <div class="alert alert-warning text-center mt-4">Không tìm thấy sản phẩm phù hợp.</div>
  {% endif %}
</div>
{% endblock %}
